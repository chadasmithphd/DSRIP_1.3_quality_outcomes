pivot_wider(names_from = c(yr),
values_from = c(value)) %>%
mutate(`diff` = `20`-`17`) %>%
mutate(avg_val = (`20`+`17`)/2) %>%
mutate(pct_diff = diff/avg_val) %>%
ggplot(aes(x=measure, y=pct_diff, label = scales::percent(pct_diff), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
scale_y_continuous(labels = scales::percent) +
geom_text(position = position_dodge(width = .9), vjust = -1.5, colour = "white", size = 3) +
#geom_text(aes(y=diff+sign(diff),label=diff), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppc_title, y="Percent Change in Mean\nPPC/1000 Member Months (2020 - 2017)") +
theme(legend.position = "none",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppr_sum_graph_w <- ppr_sum %>%
select(yr, wmean) %>%
rename(weighted = wmean) %>%
pivot_longer(cols = c(weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppr_title, x = "Year", y = "Mean PPR/1000 Admissions at Risk", caption = ppr_res_weight_statement) +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9),
plot.caption = element_text(hjust = 0))
ppr_sum_graph <- ppr_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppr_title, x = "Year", y = "Mean PPR/1000 Admissions at Risk") +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppr_diff <- ppr_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
filter(yr %in% c(17, 20)) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
pivot_wider(names_from = c(yr),
values_from = c(value)) %>%
mutate(`diff` = `20`-`17`) %>%
mutate(avg_val = (`20`+`17`)/2) %>%
mutate(pct_diff = diff/avg_val) %>%
ggplot(aes(x=measure, y=pct_diff, label = scales::percent(pct_diff), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
scale_y_continuous(labels = scales::percent) +
geom_text(position = position_dodge(width = .9), vjust = -1.5, colour = "white", size = 3) +
#geom_text(aes(y=diff+sign(diff),label=diff), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppr_title, y="Percent Change in Mean\nPPR/1000 Admissions at Risk (2020 - 2017)") +
theme(legend.position = "none",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
# Tables
ppa_summary_stats <- ppa_sum_table %>%
#                                  kbl(caption = paste0("Summary Statistics by Year: ", ppa_title)) %>%
#                                 kable_classic(full_width = FALSE, position = "left", font_size = 18) %>%
#                                 add_header_above(c(" " = 2, "Unweighted Rate" = 2, "Weighted Rate" = 2)) %>%
#                                 footnote(general = paste0(ppa_res_unweight_statement, ppa_res_weight_statement)) %>%
#                                 as_image(width = 1)
# ppc_summary_stats <- ppc_sum_table %>% kbl(caption = paste0("Summary Statistics by Year: ", ppc_title)) %>%
#                                 kable_classic(full_width = FALSE, position = "left", font_size = 18) %>%
#                                 add_header_above(c(" " = 2, "Unweighted Rate" = 2, "Weighted Rate" = 2)) %>%
#                                 footnote(general = paste0(ppc_res_unweight_statement, ppc_res_weight_statement))%>%
#                                 as_image(width = 1)
# ppr_summary_stats <- ppr_sum_table %>% kbl(caption = paste0("Summary Statistics by Year: ", ppr_title)) %>%
#                                 kable_classic(full_width = FALSE, position = "left", font_size = 18) %>%
#                                 add_header_above(c(" " = 2, "Unweighted Rate" = 2, "Weighted Rate" = 2)) %>%
#                                 footnote(general = paste0(ppr_res_unweight_statement, ppr_res_weight_statement))%>%
#                                 as_image(width = 1)
# ppv_summary_stats <- ppv_sum_table %>% kbl(caption = paste0("Summary Statistics by Year: ", ppv_title)) %>%
#                                 add_header_above(c(" " = 2, "Unweighted Rate" = 2, "Weighted Rate" = 2)) %>%
#                                 kable_classic(full_width = FALSE, position = "left", font_size = 18) %>%
#                                 footnote(general = paste0(ppv_res_unweight_statement, ppv_res_weight_statement))%>%
#                                 as_image(width = 1)
# Box plots - no longer using
ppa_box_plot_w <- ppa %>%
group_by(yr) %>%
select(yr, RHP, weighted_rate) %>%
pivot_longer(cols = weighted_rate,
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, fill = measure)) +
geom_boxplot(varwidth=T) +
scale_fill_discrete(labels = 'Weighted Rate') +
labs(title = ppa_title, x="Year", y="PPA / Total Member Months * 1000") +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_blank())
ppa_summary_stats <- ppa_sum_table %>%
regulartable()
library(tidyr)
library(ggplot2)
library(tidyverse)
library(readxl)
library(ggridges)
library(forcats)
library(writexl)
library(flextable)
library(stringr)
library(janitor)
#my_path <- "/Users/tardis/Library/CloudStorage/OneDrive-SharedLibraries-TexasA&MUniversity/Team - waiver2_final - Documents/DSRIP/DSRIP_1.4_pophealth_PPEs/analysis"
my_path <- "/Users/em/Library/CloudStorage/OneDrive-SharedLibraries-TexasA&MUniversity/Team - waiver2_final - analysis (2)"
# These are needed for the denominators for PPA & PPV (Member Months)
ppvmm <- read_xlsx(file.path(my_path, 'outputs', 'ppvmm.xlsx'))
ppamm <- read_xlsx(file.path(my_path, 'outputs', 'ppamm.xlsx'))
# 142 PPR
ppr <- read_xlsx(file.path(my_path, 'outputs', 'ppr.xlsx'))
ppr <- ppr %>%
select(RHP, yr, `Actual Number of PPR Chains`,
`Actual PPR Weights`,
`Total Admissions at Risk for PPR`) %>%
mutate(unweighted_rate = (`Actual Number of PPR Chains`/`Total Admissions at Risk for PPR`)*1000) %>%
mutate(weighted_rate = (`Actual PPR Weights`/`Total Admissions at Risk for PPR`)*1000) %>%
filter(!RHP=="N/A")
ppr_sum <- ppr %>%
group_by(yr) %>%
summarise(n=n(),
mean = mean(unweighted_rate),
median = median(unweighted_rate),
sum = sum(unweighted_rate),
sd = sd(unweighted_rate),
iqr = IQR(unweighted_rate),
wmean = mean(weighted_rate),
wmedian = median(weighted_rate),
wsum = sum(weighted_rate),
wsd = sd(weighted_rate),
wiqr = IQR(weighted_rate)) %>%
mutate(mean_sd = paste0(round(mean, 4), " (", round(sd, 4), ")"),
median_iqr = paste0(round(median, 4), " (", round(iqr, 4), ")"),
wmean_sd = paste0(round(wmean, 4), " (", round(wsd, 4), ")"),
wmedian_iqr = paste0(round(wmedian,4), " (", round(wiqr,4), ")"))
ppr_sum_table <- ppr_sum %>%
select(-mean, -median, -sd, -iqr, -wmean, -wmedian, -wsd, -wiqr, -sum, -wsum)
names(ppr_sum_table) <- c("Year", "Sample Size",  "Mean (SD)",  "Median (IQR)", "Mean (SD)",  "Median (IQR)")
# 143 PPC
ppc <- read_xlsx(file.path(my_path, 'outputs', 'ppc.xlsx'))
ppc <- ppc %>%
select(RHP, `Admissions at Risk of PPC`, `Actual PPC Weights`,
`Actual PPC counts`, yr)  %>%
mutate(weighted_rate = (`Actual PPC Weights`/`Admissions at Risk of PPC`)*1000) %>%
mutate(unweighted_rate = (`Actual PPC counts`/`Admissions at Risk of PPC`)*1000) %>%
filter(!RHP=="N/A")
ppc_sum <- ppc %>%
group_by(yr) %>%
summarise(n=n(),
mean = mean(unweighted_rate),
median = median(unweighted_rate),
sum = sum(unweighted_rate),
sd = sd(unweighted_rate),
iqr = IQR(unweighted_rate),
wmean = mean(weighted_rate),
wmedian = median(weighted_rate),
wsum = sum(weighted_rate),
wsd = sd(weighted_rate),
wiqr = IQR(weighted_rate)) %>%
mutate(mean_sd = paste0(round(mean, 4), " (", round(sd, 4), ")"),
median_iqr = paste0(round(median, 4), " (", round(iqr, 4), ")"),
wmean_sd = paste0(round(wmean, 4), " (", round(wsd, 4), ")"),
wmedian_iqr = paste0(round(wmedian,4), " (", round(wiqr,4), ")"))
ppc_sum_table <- ppc_sum  %>%
select(-mean, -median, -sd, -iqr, -wmean, -wmedian, -wsd, -wiqr, -sum, -wsum)
names(ppc_sum_table) <- c("Year", "Sample Size",  "Mean (SD)",  "Median (IQR)", "Mean (SD)",  "Median (IQR)")
# 141 PPA
ppamm <- ppamm %>%
select(RHP, `Total Member Months`, yr) %>%
filter(!RHP=="N/A")
ppa <- read_xlsx(file.path(my_path, 'outputs', 'ppa.xlsx'))
ppa <- ppa %>%
select(RHP, yr, `Actual Number of PPAs`, `Actual PPA Rate (weighted)`) %>%
filter(!RHP=="N/A")
ppa <- merge(ppa, ppamm)
ppa <- ppa %>%
mutate(weighted_rate = ((`Actual PPA Rate (weighted)`*`Actual Number of PPAs`)/`Total Member Months`)*1000) %>%
mutate(unweighted_rate = (`Actual Number of PPAs`/`Total Member Months`)*1000)
ppa_sum <- ppa %>%
group_by(yr) %>%
summarise(n=n(),
mean = mean(unweighted_rate),
median = median(unweighted_rate),
sum = sum(unweighted_rate),
sd = sd(unweighted_rate),
iqr = IQR(unweighted_rate),
wmean = mean(weighted_rate),
wmedian = median(weighted_rate),
wsum = sum(weighted_rate),
wsd = sd(weighted_rate),
wiqr = IQR(weighted_rate)) %>%
mutate(mean_sd = paste0(round(mean, 4), " (", round(sd, 4), ")"),
median_iqr = paste0(round(median,4), " (", round(iqr,4), ")"),
wmean_sd = paste0(round(wmean, 4), " (", round(wsd, 4), ")"),
wmedian_iqr = paste0(round(wmedian,4), " (", round(wiqr,4), ")"))
ppa_sum_table <- ppa_sum %>%
select(-mean, -median, -sd, -iqr, -wmean, -wmedian, -wsd, -wiqr, -sum, -wsum)
names(ppa_sum_table) <- c("Year", "Sample Size",  "Mean (SD)",  "Median (IQR)", "Mean (SD)",  "Median (IQR)")
# PPV `Actual Number of PPVs`, `Actual PPV Weight`,
ppvmm <- ppvmm %>%
select(RHP, `Total Member Months`, yr)
ppv <- read_xlsx(file.path(my_path, 'outputs', 'ppv.xlsx'))
ppv <- ppv %>%
select(RHP, yr, `Actual Number of PPVs`,
`Actual PPV Rate (weighted)`) %>%
filter(!RHP=="N/A")
ppv <- merge(ppv, ppvmm)
# 144
ppv <- ppv %>%
mutate(weighted_rate = ((`Actual Number of PPVs`* `Actual PPV Rate (weighted)`)/`Total Member Months`) *1000) %>%
mutate(unweighted_rate = (`Actual Number of PPVs`/`Total Member Months`)*1000)
ppv_sum <- ppv %>%
group_by(yr) %>%
summarise(n=n(),
mean = mean(unweighted_rate),
median = median(unweighted_rate),
sum = sum(unweighted_rate),
sd = sd(unweighted_rate),
iqr = IQR(unweighted_rate),
wmean = mean(weighted_rate),
wmedian = median(weighted_rate),
wsum = sum(weighted_rate),
wsd = sd(weighted_rate),
wiqr = IQR(weighted_rate)) %>%
mutate(mean_sd = paste0(round(mean, 4), " (", round(sd, 4), ")"),
median_iqr = paste0(round(median,4), " (", round(iqr,4), ")"),
wmean_sd = paste0(round(wmean, 4), " (", round(wsd, 4), ")"),
wmedian_iqr = paste0(round(wmedian,4), " (", round(wiqr,4), ")"))
ppv_sum_table <- ppv_sum %>%
select(-mean, -median, -sd, -iqr, -wmean, -wmedian, -wsd, -wiqr, -sum, -wsum)
names(ppv_sum_table) <- c("Year", "Sample Size",  "Mean (SD)",  "Median (IQR)", "Mean (SD)",  "Median (IQR)")
# Titles
ppa_title <- "1.4.1 Potentially preventable admissions (PPA)"
ppr_title <- "1.4.2 Potentially preventable readmissions (PPR)"
ppc_title <- "1.4.3 Potentially preventable complications (PPC)"
ppv_title <- "1.4.4 Potentially preventable Emergency\nDepartment visits (PPV)"
# Rearrange data for testing
ppa_test <- ppa %>%
select(yr, RHP, weighted_rate, unweighted_rate) %>%
pivot_wider(names_from = yr, values_from = c(weighted_rate, unweighted_rate))
ppc_test <- ppc %>%
select(yr, RHP, weighted_rate, unweighted_rate) %>%
pivot_wider(names_from = yr, values_from = c(weighted_rate, unweighted_rate))
ppr_test <- ppr %>%
select(yr, RHP, weighted_rate, unweighted_rate) %>%
pivot_wider(names_from = yr, values_from = c(weighted_rate, unweighted_rate))
ppv_test <- ppv %>%
select(yr, RHP, weighted_rate, unweighted_rate) %>%
pivot_wider(names_from = yr, values_from = c(weighted_rate, unweighted_rate))
# Wilcoxin
ppa_res_weight <- wilcox.test(ppa_test$weighted_rate_17, ppa_test$weighted_rate_20, paired = TRUE)
ppa_res_unweight <- wilcox.test(ppa_test$unweighted_rate_17, ppa_test$unweighted_rate_20, paired = TRUE)
ppc_res_weight <- wilcox.test(ppc_test$weighted_rate_17, ppc_test$weighted_rate_20, paired = TRUE)
ppc_res_unweight <- wilcox.test(ppc_test$unweighted_rate_17, ppc_test$unweighted_rate_20, paired = TRUE)
ppv_res_weight <- wilcox.test(ppv_test$weighted_rate_17, ppv_test$weighted_rate_20, paired = TRUE)
ppv_res_unweight <- wilcox.test(ppv_test$unweighted_rate_17, ppv_test$unweighted_rate_20, paired = TRUE)
ppr_res_weight <- wilcox.test(ppr_test$weighted_rate_17, ppr_test$weighted_rate_20, paired = TRUE)
ppr_res_unweight <- wilcox.test(ppr_test$unweighted_rate_17, ppr_test$unweighted_rate_20, paired = TRUE)
test_p <- function(value1) {
if(value1 < .05){paste0("is statistically\nsignificant")}
else{paste0("is not statistically\nsignificant")}
}
test_p2 <- function(value1) {
if(value1 < .05){paste0("< .05")}
else{paste0("= ", value1)}
}
ppa_res_weight_statement <- paste0("Difference between 2017 and 2020 weighted rates ", test_p(ppa_res_weight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppa_res_weight$statistic, 3), ", p ", test_p2(ppa_res_weight$p.value),"). \n")
ppa_res_unweight_statement <- paste0("Difference between 2017 and 2020 unweighted rates ", test_p(ppa_res_unweight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppa_res_unweight$statistic, 3), ", p ", test_p2(ppa_res_unweight$p.value),"). \n")
ppc_res_weight_statement <- paste0("Difference between 2017 and 2020 weighted rates ", test_p(ppc_res_weight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppc_res_weight$statistic, 3), ", p ", test_p2(ppc_res_weight$p.value),"). \n")
ppc_res_unweight_statement <- paste0("Difference between 2017 and 2020 unweighted rates ", test_p(ppc_res_unweight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppc_res_unweight$statistic, 3), ", p ", test_p2(ppc_res_unweight$p.value),"). \n")
ppv_res_weight_statement <- paste0("Difference between 2017 and 2020 weighted rates ", test_p(ppv_res_weight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppv_res_weight$statistic, 3), ", p ", test_p2(ppv_res_weight$p.value),"). \n")
ppv_res_unweight_statement <- paste0("Difference between 2017 and 2020 unweighted rates ", test_p(ppv_res_unweight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppv_res_unweight$statistic, 3), ", p ", test_p2(ppv_res_unweight$p.value),"). \n")
ppr_res_weight_statement <- paste0("Difference between 2017 and 2020 weighted rates ", test_p(ppr_res_weight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppr_res_weight$statistic, 3), ", p ", test_p2(ppr_res_weight$p.value),"). \n")
ppr_res_unweight_statement <- paste0("Difference between 2017 and 2020 unweighted rates ", test_p(ppr_res_unweight$p.value), " after conducting Wilcoxon signed rank sum test (V = ", round(ppr_res_unweight$statistic, 3), ", p ", test_p2(ppr_res_unweight$p.value),"). \n")
# Visuals
ppa_sum_graph <- ppa_sum %>%
select(yr, wmean, mean) %>%
rename(unweighted = mean, weighted = wmean) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y = value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppa_title, x="Year", y="Mean PPA/1000 Member Months") +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppa_sum_graph_w <- ppa_sum %>%
select(yr, wmean) %>%
rename(weighted = wmean) %>%
pivot_longer(cols = c(weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppa_title, x="Year", y="Mean PPA/1000 Member Months", caption = ppa_res_weight_statement) +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9),
plot.caption = element_text(hjust = 0))
ppa_diff <- ppa_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
filter(yr %in% c(17, 20)) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
pivot_wider(names_from = c(yr),
values_from = c(value)) %>%
mutate(`diff` = `20`-`17`) %>%
mutate(avg_val = (`20`+`17`)/2) %>%
mutate(pct_diff = diff/avg_val) %>%
ggplot(aes(x=measure, y=pct_diff, label = scales::percent(pct_diff), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = -1.5, colour = "white", size = 3) +
scale_y_continuous(labels = scales::percent) +
labs(title = ppa_title, y="Percent Change in Mean\nPPA/1000 Member Months (2020 - 2017)") +
theme(legend.position = "none",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppv_sum_graph_w <- ppv_sum %>%
select(yr, wmean) %>%
rename(weighted = wmean) %>%
pivot_longer(cols = c(weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppv_title, x="Year", y="Mean PPV/1000 Member Months", caption = ppv_res_weight_statement) +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9),
plot.caption = element_text(hjust = 0))
ppv_diff <- ppv_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
filter(yr %in% c(17, 20)) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
pivot_wider(names_from = c(yr),
values_from = c(value)) %>%
mutate(`diff` = `20`-`17`) %>%
mutate(avg_val = (`20`+`17`)/2) %>%
mutate(pct_diff = diff/avg_val) %>%
ggplot(aes(x=measure, y=pct_diff, label = scales::percent(pct_diff), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
scale_y_continuous(labels = scales::percent) +
geom_text(position = position_dodge(width = .9), vjust = -1.5, colour = "white", size = 3) +
#geom_text(aes(y=diff+sign(diff),label=diff), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppv_title, y="Percent Change in Mean\nPPV/1000 Member Months (2020 - 2017)") +
theme(legend.position = "none",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppv_sum_graph <- ppv_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppv_title, x="Year", y="Mean PPV/1000 Member Months") +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppc_sum_graph_w <- ppc_sum %>%
select(yr, wmean) %>%
rename(weighted = wmean) %>%
pivot_longer(cols = c(weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
labs(title = ppc_title, x="Year", y="Mean PPC/1000 Member Months", caption = ppc_res_weight_statement) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9),
plot.caption = element_text(hjust = 0))
ppc_sum_graph <- ppc_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
labs(title = ppc_title, x="Year", y="Mean PPC/1000 Member Months") +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppc_diff <- ppc_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
filter(yr %in% c(17, 20)) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
pivot_wider(names_from = c(yr),
values_from = c(value)) %>%
mutate(`diff` = `20`-`17`) %>%
mutate(avg_val = (`20`+`17`)/2) %>%
mutate(pct_diff = diff/avg_val) %>%
ggplot(aes(x=measure, y=pct_diff, label = scales::percent(pct_diff), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
scale_y_continuous(labels = scales::percent) +
geom_text(position = position_dodge(width = .9), vjust = -1.5, colour = "white", size = 3) +
#geom_text(aes(y=diff+sign(diff),label=diff), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppc_title, y="Percent Change in Mean\nPPC/1000 Member Months (2020 - 2017)") +
theme(legend.position = "none",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppr_sum_graph_w <- ppr_sum %>%
select(yr, wmean) %>%
rename(weighted = wmean) %>%
pivot_longer(cols = c(weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppr_title, x = "Year", y = "Mean PPR/1000 Admissions at Risk", caption = ppr_res_weight_statement) +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9),
plot.caption = element_text(hjust = 0))
ppr_sum_graph <- ppr_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
ggplot(aes(x=as.factor(yr), y=value, label = round(value, 2), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
geom_text(position = position_dodge(width = .9), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppr_title, x = "Year", y = "Mean PPR/1000 Admissions at Risk") +
theme(legend.position = "top",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
ppr_diff <- ppr_sum %>%
select(yr, mean, wmean) %>%
rename(unweighted = mean, weighted = wmean) %>%
filter(yr %in% c(17, 20)) %>%
pivot_longer(cols = c(unweighted, weighted),
names_to = "measure",
values_to = "value") %>%
pivot_wider(names_from = c(yr),
values_from = c(value)) %>%
mutate(`diff` = `20`-`17`) %>%
mutate(avg_val = (`20`+`17`)/2) %>%
mutate(pct_diff = diff/avg_val) %>%
ggplot(aes(x=measure, y=pct_diff, label = scales::percent(pct_diff), fill = measure)) +
geom_bar(stat = "identity", position = position_dodge()) +
scale_y_continuous(labels = scales::percent) +
geom_text(position = position_dodge(width = .9), vjust = -1.5, colour = "white", size = 3) +
#geom_text(aes(y=diff+sign(diff),label=diff), vjust = 1.5, colour = "white", size = 3) +
labs(title = ppr_title, y="Percent Change in Mean\nPPR/1000 Admissions at Risk (2020 - 2017)") +
theme(legend.position = "none",
legend.key.size = unit(.30, 'cm'),
legend.text = element_text(size=7.5),
legend.title = element_text(size=9))
# Tables
ppa_summary_stats <- ppa_sum_table %>%
regulartable()
View(ppa_sum)
names(ppa_sum)
names(ppa_sum_table)
View(ppa_sum_table)
names(ppa_sum_table) <- c("Year", "Sample Size",  "Unweighted Mean (SD)",  " Unweighted Median (IQR)", "Weighted Mean (SD)",  "Weighted Median (IQR)")
ppa_summary_stats <- ppa_sum_table %>%
regulartable()
View(ppa_summary_stats)
names(ppr_sum_table) <- c("Year", "Sample Size",  "Unweighted Mean (SD)",  "Unweighted Median (IQR)", "Weighted Mean (SD)",  "Weighted Median (IQR)")
ppr_summary_stats <- ppr_sum_table %>%
regulartable()
ppr_summary_note <- paste0(ppr_res_unweight_statement, ppr_res_weight_statement)
names(ppc_sum_table) <- c("Year", "Sample Size",  "Unweighted Mean (SD)",  "Unweighted Median (IQR)", "Weighted Mean (SD)",  "Weighted Median (IQR)")
ppc_summary_stats <- ppc_sum_table %>%
regulartable()
ppc_summary_note <- paste0(ppc_res_unweight_statement, ppc_res_weight_statement)
names(ppv_sum_table) <- c("Year", "Sample Size",  "Unweighted Mean (SD)",  "Unweighted Median (IQR)", "Weighted Mean (SD)",  "Weighted Median (IQR)")
ppv_summary_stats <- ppv_sum_table %>%
regulartable()
ppv_summary_note <- paste0(ppv_res_unweight_statement, ppv_res_weight_statement)
